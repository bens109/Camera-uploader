<!DOCTYPE html>
<html>
<head>
  <title>Polaroid Camera</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    html, body { margin:0; padding:0; height:100%; background:#222; font-family:sans-serif; overflow:hidden; }
    #camera-container { position:relative; width:100%; height:100%; display:flex; justify-content:center; align-items:center; background:#111; }
    video { width:100%; height:100%; object-fit:cover; transform: scaleX(1); }
    #preview { position:absolute; bottom:120px; right:20px; width:180px; height:230px; border:10px solid white; border-bottom-width:40px; border-radius:10px; box-shadow:0 8px 15px rgba(0,0,0,0.5); display:none; object-fit:cover; z-index:3; transition:opacity 0.3s ease; background:white; }
    #flash { position:absolute; top:0; left:0; width:100%; height:100%; background:white; opacity:0; z-index:4; }
    #focus-ring { position:absolute; width:100px; height:100px; border:3px solid yellow; border-radius:50%; pointer-events:none; display:none; transform:translate(-50%, -50%); z-index:6; }
    #top-controls { position:absolute; top:20px; width:100%; display:flex; justify-content:space-between; padding:0 20px; z-index:5; }
    .top-button { background:rgba(255,255,255,0.3); border:2px solid white; color:white; border-radius:50%; width:270px; height:270px; font-size:108px; }
    #controls { position:absolute; bottom:50px; width:100%; display:flex; justify-content:center; z-index:5; }
    #shutter-button { border:6px solid white; background:rgba(255,255,255,0.3); border-radius:50%; width:420px; height:420px; font-size:150px; }
    #zoom-slider { position:absolute; bottom:10px; left:50%; transform:translateX(-50%); width:60%; z-index:5; }
    #status-container { position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); width:80%; max-width:600px; background:rgba(0,0,0,0.7); border-radius:20px; padding:20px; z-index:6; display:none; text-align:center; color:#fff; }
    #status-text { font-size:28px; margin-bottom:10px; }
    .progress-bar { width:100%; height:25px; background:#444; border-radius:15px; overflow:hidden; margin-bottom:10px; }
    .progress-fill { width:0%; height:100%; background:#0f0; transition:width 0.2s; }
    #fileInput { display:none; }
  </style>
</head>
<body>
  <div id="camera-container">
    <video autoplay playsinline></video>
    <div id="focus-ring"></div>
    <img id="preview"/>
    <div id="flash"></div>

    <div id="top-controls">
      <button id="flashButton" class="top-button" onclick="toggleFlash()">üí°</button>
      <div style="display:flex;gap:10px;">
        <button id="uploadButton" class="top-button" onclick="triggerFileInput()">üìÅ</button>
        <button class="top-button" onclick="flipCamera()">üîÑ</button>
      </div>
    </div>

    <input type="file" id="fileInput" accept="image/*" multiple onchange="uploadSelectedFiles(this.files)">
    <div id="controls">
      <button id="shutter-button" onclick="takePhoto()">üì∑</button>
    </div>
    <input type="range" id="zoom-slider" min="1" max="3" step="0.01" value="1">

    <div id="status-container">
      <div id="status-text"></div>
      <div class="progress-bar">
        <div id="image-progress" class="progress-fill"></div>
      </div>
      <div class="progress-bar">
        <div id="batch-progress" class="progress-fill"></div>
      </div>
    </div>
  </div>

  <canvas style="display:none;"></canvas>
  <audio id="shutter" src="https://actions.google.com/sounds/v1/camera/shutter_click.ogg" preload="auto"></audio>

  <script>
    // ========== CONFIG: your Google Apps Script URL ==============
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbxZ7MCt4yPZqbrnOVr4yTp2gl1oDrhSJnXrUiQ3AIAdj6UHB3B8sgzoCO0aGFlFxbBi/exec';

    let currentFacingMode = 'environment',
        stream = null,
        track = null,
        flashOn = false;

    async function initCamera(){
      if (stream) stream.getTracks().forEach(t => t.stop());
      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: {
            facingMode: currentFacingMode,
            width: { ideal: 4096 }, height: { ideal: 2160 }
          }
        });
        const video = document.querySelector('video');
        video.srcObject = stream;
        video.style.transform = currentFacingMode === 'user' ? 'scaleX(-1)' : 'scaleX(1)';
        await video.play();
        track = stream.getVideoTracks()[0];
      } catch (err) {
        showStatus('‚ö†Ô∏è Camera access failed', 0, 0);
      }
    }

    async function flipCamera(){
      currentFacingMode = (currentFacingMode === 'user') ? 'environment' : 'user';
      flashOn = false;
      await initCamera();
    }

    async function toggleFlash(){
      if (!track) return;
      try {
        await track.applyConstraints({ advanced: [{ torch: !flashOn }] });
        flashOn = !flashOn;
        document.getElementById('flashButton').textContent = flashOn ? 'üî¶' : 'üí°';
      } catch (err) {
        showStatus('‚ö†Ô∏è Flash not supported', 0, 0);
      }
    }

    function playFlashAnimation(){
      const flash = document.getElementById('flash');
      flash.style.opacity = 0.8;
      setTimeout(() => flash.style.opacity = 0, 100);
    }

    function showStatus(text, imagePct = 0, batchPct = 0){
      const container = document.getElementById('status-container');
      container.style.display = 'block';
      document.getElementById('status-text').innerHTML = text;
      document.getElementById('image-progress').style.width = imagePct + '%';
      document.getElementById('batch-progress').style.width = batchPct + '%';
    }

    async function takePhoto(){
      const video = document.querySelector('video');
      const canvas = document.querySelector('canvas');
      const ctx = canvas.getContext('2d');
      const scale = Math.min(1920 / video.videoWidth, 1080 / video.videoHeight, 1);
      canvas.width = video.videoWidth * scale;
      canvas.height = video.videoHeight * scale;
      if (currentFacingMode === 'user') {
        ctx.translate(canvas.width, 0);
        ctx.scale(-1, 1);
      }
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      ctx.setTransform(1, 0, 0, 1, 0, 0);
      document.getElementById('shutter').play();
      playFlashAnimation();
      const dataUrl = canvas.toDataURL('image/jpeg', 0.95);
      showPreview(dataUrl);
      await uploadCapturedImage(dataUrl);
    }

    function showPreview(dataUrl){
      const preview = document.getElementById('preview');
      preview.src = dataUrl;
      preview.style.display = 'block';
      preview.style.opacity = 1;
      setTimeout(() => { preview.style.opacity = 0; }, 1000);
    }

    async function uploadCapturedImage(dataUrl){
      const base64 = dataUrl.split(',')[1];
      const filename = 'photo_' + Date.now() + '.jpg';
      showStatus('Uploading 1 of 1', 0, 0);
      try {
        const response = await fetch(GAS_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ image: base64, filename: filename })
        });
        const result = await response.json();
        if (result && result.url) {
          showStatus(`Uploaded! <a href="${result.url}" target="_blank">View File</a>`, 100, 100);
        } else {
          showStatus('‚ùå Upload failed', 0, 0);
        }
      } catch (err) {
        showStatus('‚ùå Upload error', 0, 0);
        console.error(err);
      }
      setTimeout(() => document.getElementById('status-container').style.display = 'none', 2000);
    }

    function triggerFileInput(){
      document.getElementById('fileInput').click();
    }

    async function uploadSelectedFiles(files){
      const total = files.length;
      if (total === 0) return;
      showStatus(`Uploading 0 of ${total}`, 0, 0);
      let completed = 0;

      const updateProgress = () => {
        completed++;
        const batchPct = (completed / total) * 100;
        showStatus(`Uploaded ${completed} of ${total}`, 100, batchPct);
      };

      for (const file of files) {
        const reader = new FileReader();
        await new Promise((resolve, reject) => {
          reader.onload = async (e) => {
            const dataUrl = e.target.result;
            showPreview(dataUrl);
            const base64 = dataUrl.split(',')[1];
            const filename = file.name || 'uploaded_' + Date.now() + '.jpg';
            try {
              const response = await fetch(GAS_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ image: base64, filename: filename })
              });
              const result = await response.json();
              // optionally you can inspect result.url
            } catch (err) {
              console.error('Upload error for file:', file.name, err);
            }
            updateProgress();
            resolve();
          };
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
      }
      // all done
    }

    document.getElementById('zoom-slider').addEventListener('input', async e => {
      if (track) {
        try {
          await track.applyConstraints({ advanced: [{ zoom: e.target.value }] });
        } catch (e) {
          console.log('Zoom not supported');
        }
      }
    });

    const videoContainer = document.getElementById('camera-container');
    const focusRing = document.getElementById('focus-ring');
    videoContainer.addEventListener('click', async e => {
      const rect = videoContainer.getBoundingClientRect();
      const x = (e.clientX - rect.left) / rect.width;
      const y = (e.clientY - rect.top) / rect.height;
      focusRing.style.left = `${e.clientX}px`;
      focusRing.style.top = `${e.clientY}px`;
      focusRing.style.display = 'block';
      setTimeout(() => focusRing.style.display = 'none', 800);
      if (track && track.getCapabilities().focusMode) {
        try {
          await track.applyConstraints({ advanced: [{ focusMode: 'manual', focusPointX: x, focusPointY: y }] });
        } catch (e) {
          console.log('Tap focus not supported');
        }
      }
    });

    window.onload = initCamera;
  </script>
</body>
</html>
