<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Camera</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background: black;
      overflow: hidden;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      color: white;
      touch-action: none;
    }
    #camera-container {
      position: relative;
      width: 100%;
      height: 100%;
      background: black;
    }
    video, canvas {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      object-fit: cover;
      transform: scaleX(-1); /* Mirror for selfie feel */
    }
    #preview {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      object-fit: cover;
      display: none;
      z-index: 10;
    }
    #controls {
      position: absolute;
      bottom: 40px;
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      z-index: 20;
    }
    #buttons {
      display: flex;
      justify-content: space-around;
      width: 80%;
      margin-top: 15px;
    }
    .btn {
      background: rgba(255,255,255,0.15);
      border: 2px solid white;
      border-radius: 50%;
      width: 80px; height: 80px;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 28px;
      cursor: pointer;
      transition: transform 0.1s;
    }
    .btn:active { transform: scale(0.9); }
    #flash-btn.active { background: yellow; border-color: yellow; }
    #zoom-slider {
      width: 60%;
      margin-top: 15px;
      -webkit-appearance: none;
      height: 4px;
      border-radius: 2px;
      background: white;
    }
    #progress-container {
      position: absolute;
      top: 20px; left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.5);
      padding: 10px 20px;
      border-radius: 12px;
      display: none;
      z-index: 30;
      text-align: center;
    }
    #progress-bar {
      height: 5px;
      background: lime;
      width: 0%;
      border-radius: 3px;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <div id="camera-container">
    <video id="camera" autoplay playsinline></video>
    <canvas id="canvas"></canvas>
    <img id="preview" />
    <div id="progress-container">
      <div id="progress-text">Uploading 0%</div>
      <div id="progress-bar"></div>
    </div>
    <div id="controls">
      <input type="range" id="zoom-slider" min="1" max="3" step="0.1" value="1">
      <div id="buttons">
        <div id="flash-btn" class="btn">âš¡</div>
        <div id="capture-btn" class="btn">ðŸ“¸</div>
        <div id="switch-btn" class="btn">ðŸ”„</div>
      </div>
    </div>
  </div>

  <script>
    const camera = document.getElementById('camera');
    const canvas = document.getElementById('canvas');
    const preview = document.getElementById('preview');
    const flashBtn = document.getElementById('flash-btn');
    const captureBtn = document.getElementById('capture-btn');
    const switchBtn = document.getElementById('switch-btn');
    const zoomSlider = document.getElementById('zoom-slider');
    const progressContainer = document.getElementById('progress-container');
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');

    let stream;
    let useFrontCamera = true;
    let flashOn = false;
    let track;

    async function initCamera() {
      if (stream) stream.getTracks().forEach(t => t.stop());

      const constraints = {
        video: {
          facingMode: useFrontCamera ? 'user' : 'environment',
          width: { ideal: 1920 },
          height: { ideal: 1080 }
        },
        audio: false
      };

      try {
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        camera.srcObject = stream;
        track = stream.getVideoTracks()[0];
        const capabilities = track.getCapabilities();
        if (capabilities.zoom) {
          zoomSlider.min = capabilities.zoom.min || 1;
          zoomSlider.max = capabilities.zoom.max || 3;
          zoomSlider.step = capabilities.zoom.step || 0.1;
          zoomSlider.value = track.getSettings().zoom || 1;
          zoomSlider.style.display = 'block';
        } else {
          zoomSlider.style.display = 'none';
        }
      } catch (err) {
        alert('Camera failed: ' + err);
      }
    }

    zoomSlider.addEventListener('input', () => {
      const zoom = parseFloat(zoomSlider.value);
      track.applyConstraints({ advanced: [{ zoom }] });
    });

    flashBtn.addEventListener('click', () => {
      flashOn = !flashOn;
      flashBtn.classList.toggle('active', flashOn);
    });

    switchBtn.addEventListener('click', () => {
      useFrontCamera = !useFrontCamera;
      initCamera();
    });

    camera.addEventListener('click', (e) => {
      const rect = camera.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      // Simulate tap-to-focus animation
      const focusRing = document.createElement('div');
      focusRing.style.position = 'absolute';
      focusRing.style.left = `${x - 25}px`;
      focusRing.style.top = `${y - 25}px`;
      focusRing.style.width = '50px';
      focusRing.style.height = '50px';
      focusRing.style.border = '2px solid white';
      focusRing.style.borderRadius = '50%';
      focusRing.style.pointerEvents = 'none';
      focusRing.style.zIndex = 50;
      camera.parentNode.appendChild(focusRing);
      setTimeout(() => focusRing.remove(), 1000);
    });

    captureBtn.addEventListener('click', async () => {
      const ctx = canvas.getContext('2d');
      canvas.width = camera.videoWidth;
      canvas.height = camera.videoHeight;
      ctx.drawImage(camera, 0, 0, canvas.width, canvas.height);
      canvas.toBlob(async (blob) => {
        const url = URL.createObjectURL(blob);
        preview.src = url;
        preview.style.display = 'block';
        await uploadImage(blob);
        setTimeout(() => preview.style.display = 'none', 2000);
      }, 'image/jpeg', 1.0);
    });

    async function uploadImage(blob) {
      const formData = new FormData();
      formData.append('file', blob, `photo_${Date.now()}.jpg`);
      const url = "https://script.google.com/macros/s/AKfycbzTC2K3FSKbNoYdZq2VjKEXAzm1gPxj4JKGTRIjuBADQ4JroT3YFAYICVs63riOixZF/exec";

      progressContainer.style.display = 'block';
      progressBar.style.width = '0%';
      progressText.textContent = 'Uploading 0%';

      return new Promise((resolve, reject) => {
        const xhr = new XMLHttpRequest();
        xhr.open('POST', url, true);
        xhr.upload.onprogress = (e) => {
          if (e.lengthComputable) {
            const percent = Math.round((e.loaded / e.total) * 100);
            progressBar.style.width = percent + '%';
            progressText.textContent = 'Uploading ' + percent + '%';
          }
        };
        xhr.onload = () => {
          if (xhr.status === 200) {
            progressBar.style.width = '100%';
            progressText.textContent = 'Uploaded!';
            setTimeout(() => progressContainer.style.display = 'none', 1500);
            resolve();
          } else reject();
        };
        xhr.onerror = reject;
        xhr.send(formData);
      });
    }

    initCamera();
  </script>
</body>
</html>
