<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Camera Uploader</title>
<style>
html, body { margin:0; padding:0; height:100%; background:#222; font-family:sans-serif; overflow:hidden; }
#camera-container { position:relative; width:100%; height:100%; display:flex; justify-content:center; align-items:center; background:#111; }
video { width:100%; height:100%; object-fit:cover; transform: scaleX(1); }
#preview { position:absolute; bottom:120px; right:20px; width:180px; height:230px; border:10px solid white; border-bottom-width:40px; border-radius:10px; box-shadow:0 8px 15px rgba(0,0,0,0.5); display:none; object-fit:cover; z-index:3; transition:opacity 0.3s ease; background:white; }
#flash { position:absolute; top:0; left:0; width:100%; height:100%; background:white; opacity:0; z-index:4; }
#top-controls { position:absolute; top:20px; width:100%; display:flex; justify-content:space-between; padding:0 20px; z-index:5; }
.top-button { background:rgba(255,255,255,0.3); border:2px solid white; color:white; border-radius:50%; width:120px; height:120px; font-size:48px; }
#controls { position:absolute; bottom:50px; width:100%; display:flex; justify-content:center; z-index:5; }
#shutter-button { border:6px solid white; background:rgba(255,255,255,0.3); border-radius:50%; width:180px; height:180px; font-size:72px; }
#status-container { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:80%; max-width:600px; background:rgba(0,0,0,0.7); border-radius:20px; padding:20px; z-index:6; display:none; text-align:center; color:#fff; }
#status-text { font-size:20px; margin-bottom:10px; }
.progress-bar { width:100%; height:15px; background:#444; border-radius:15px; overflow:hidden; margin-bottom:10px; }
.progress-fill { width:0%; height:100%; background:#0f0; transition:width 0.1s; }
#fileInput { display:none; }
</style>
</head>
<body>
<div id="camera-container">
  <video autoplay playsinline></video>
  <img id="preview"/>
  <div id="flash"></div>

  <div id="top-controls">
    <button id="flashButton" class="top-button" onclick="toggleFlash()">üí°</button>
    <div style="display:flex;gap:10px;">
      <button id="uploadButton" class="top-button" onclick="triggerFileInput()">üìÅ</button>
      <button class="top-button" onclick="flipCamera()">üîÑ</button>
    </div>
  </div>

  <input type="file" id="fileInput" accept="image/*" multiple onchange="uploadSelectedFiles(this.files)">
  <div id="controls">
    <button id="shutter-button" onclick="takePhoto()">üì∑</button>
  </div>

  <div id="status-container">
    <div id="status-text"></div>
    <div class="progress-bar">
      <div id="image-progress" class="progress-fill"></div>
    </div>
    <div class="progress-bar">
      <div id="batch-progress" class="progress-fill"></div>
    </div>
  </div>
</div>

<canvas style="display:none;"></canvas>
<audio id="shutter" src="https://actions.google.com/sounds/v1/camera/shutter_click.ogg" preload="auto"></audio>

<script>
let currentFacingMode='environment',stream=null,track=null,flashOn=false;
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxNqsgc5nZrOZ2aDUYmRvivGNlLJYdqbbDL0zPydoIRKlOuwa6iwjbvj2v2Xg2S3TV0dQ/exec";

async function initCamera(){
  if(stream) stream.getTracks().forEach(t=>t.stop());
  try{
    stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:currentFacingMode,width:{ideal:1920},height:{ideal:1080}}});
    const video=document.querySelector('video');
    video.srcObject=stream;
    video.style.transform=currentFacingMode==='user'?'scaleX(-1)':'scaleX(1)';
    await video.play();
    track=stream.getVideoTracks()[0];
  }catch(err){
    showStatus('‚ö†Ô∏è Camera access failed',0,0);
    console.error(err);
  }
}

async function flipCamera(){ currentFacingMode=currentFacingMode==='user'?'environment':'user'; flashOn=false; await initCamera();}
async function toggleFlash(){ 
  if(!track) return; 
  try{ 
    await track.applyConstraints({advanced:[{torch:!flashOn}]}); 
    flashOn=!flashOn; 
    document.getElementById('flashButton').textContent=flashOn?'üî¶':'üí°'; 
  }catch(err){ showStatus('‚ö†Ô∏è Flash not supported',0,0);}
}

function playFlashAnimation(){ const flash=document.getElementById('flash'); flash.style.opacity=0.8; setTimeout(()=>flash.style.opacity=0,100); }

function showStatus(text,imagePct=0,batchPct=0){
  const container=document.getElementById('status-container');
  container.style.display='block';
  document.getElementById('status-text').innerHTML=text;
  document.getElementById('image-progress').style.width=imagePct+'%';
  document.getElementById('batch-progress').style.width=batchPct+'%';
}

async function takePhoto(){
  const video=document.querySelector('video');
  const canvas=document.querySelector('canvas');
  const ctx=canvas.getContext('2d');
  canvas.width=video.videoWidth;
  canvas.height=video.videoHeight;
  if(currentFacingMode==='user'){ctx.translate(canvas.width,0);ctx.scale(-1,1);}
  ctx.drawImage(video,0,0,canvas.width,canvas.height);
  ctx.setTransform(1,0,0,1,0,0);
  document.getElementById('shutter').play();
  playFlashAnimation();
  const blob = await new Promise(resolve => canvas.toBlob(resolve,'image/jpeg',0.95));
  showPreview(URL.createObjectURL(blob));
  await uploadFileWithProgress(blob);
}

function showPreview(url){ const preview=document.getElementById('preview'); preview.src=url; preview.style.display='block'; setTimeout(()=>{preview.style.opacity=0;},1000); }

function triggerFileInput(){document.getElementById('fileInput').click();}

async function uploadSelectedFiles(files){
  const total=files.length;
  if(total===0) return;
  let completed=0;
  const batchProgress = Array(total).fill(0);
  Array.from(files).forEach((file, idx)=>{
    uploadFileWithProgress(file, (percent)=>{
      batchProgress[idx]=percent;
      const totalPct = batchProgress.reduce((a,b)=>a+b,0)/total;
      showStatus(`Uploading ${completed+1} of ${total}`, percent, totalPct);
    }).then(()=>{
      completed++;
      showStatus(`Uploaded ${completed} of ${total}`,100,(batchProgress.reduce((a,b)=>a+b,0)/total));
    });
  });
}

function uploadFileWithProgress(file, progressCallback){
  return new Promise((resolve,reject)=>{
    const xhr = new XMLHttpRequest();
    const formData = new FormData();
    formData.append("file", file, file.name);
    xhr.upload.onprogress = function(e){
      if(e.lengthComputable){
        const percent = (e.loaded/e.total)*100;
        if(progressCallback) progressCallback(percent);
      }
    };
    xhr.onload = function(){
      if(xhr.status===200){
        if(progressCallback) progressCallback(100);
        resolve();
      } else { reject(xhr.responseText); }
    };
    xhr.onerror = function(){ reject("Upload failed"); };
    xhr.open("POST", WEB_APP_URL);
    xhr.send(formData);
  });
}

window.onload=initCamera;
</script>
</body>
</html>
